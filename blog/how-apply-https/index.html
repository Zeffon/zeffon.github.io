<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="My Site" href="/opensearch.xml"><title data-react-helmet="true">免费https通配符证书申请与配置 | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zeffon.github.io/blog/how-apply-https"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="免费https通配符证书申请与配置 | My Site"><meta data-react-helmet="true" name="description" content="Certbot 是 EFF 加密整个互联网的一部分。通过 Web 进行安全通信依赖于 HTTPS，这需要使用数字证书，以便浏览器验证 Web 服务器的身份。"><meta data-react-helmet="true" property="og:description" content="Certbot 是 EFF 加密整个互联网的一部分。通过 Web 进行安全通信依赖于 HTTPS，这需要使用数字证书，以便浏览器验证 Web 服务器的身份。"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2019-09-09T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/zeffon"><meta data-react-helmet="true" property="article:tag" content="linux,https"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://zeffon.github.io/blog/how-apply-https"><link data-react-helmet="true" rel="alternate" href="https://zeffon.github.io/blog/how-apply-https" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zeffon.github.io/blog/how-apply-https" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://YOUR_APP_ID-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.c95fcd8c.css">
<link rel="preload" href="/assets/js/runtime~main.89f3db80.js" as="script">
<link rel="preload" href="/assets/js/main.410e0645.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">首页</b></a><a class="navbar__item navbar__link" href="/docs/intro">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://www.yuque.com/zeffon/blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>语雀<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/zeffon" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/vite">Vite 的介绍</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/get-param-array">GET请求如何传递数组参数</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/text-show">文本控制显示方式</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/js-array">JS 数组的总结</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/js-object">JS 对象的操作</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">免费https通配符证书申请与配置</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2019-09-09T00:00:00.000Z" itemprop="datePublished">September 9, 2019</time> · 4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/zeffon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/zeffon.png" alt="Zeffon Wu"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zeffon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Zeffon Wu</span></a></div><small class="avatar__subtitle" itemprop="description">A web engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Certbot 是 EFF 加密整个互联网的一部分。通过 Web 进行安全通信依赖于 HTTPS，这需要使用数字证书，以便浏览器验证 Web 服务器的身份。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="前言"></a>前言<a class="hash-link" href="#前言" title="Direct link to heading">#</a></h2><p>Certbot 是 EFF 加密整个互联网的一部分。通过 Web 进行安全通信依赖于 HTTPS，这需要使用数字证书，以便浏览器验证 Web 服务器的身份。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="lets-encrypt-简介"></a>Let&#x27;s Encrypt 简介<a class="hash-link" href="#lets-encrypt-简介" title="Direct link to heading">#</a></h3><p>随着阿里免费的 HTTPS 过期后，不得不使用免费使用 HTTPS。所以就需要从证书授权机构(以下简称 CA) 处获取一个证书，Let&#x27;s Encrypt 就是一个 CA。我们可以从 Let&#x27;s Encrypt 获得网站域名的免费的证书。这篇文章也主要讲的是通过 Let&#x27;s Encrypt + Nginx 来让网站升级到 HTTPS。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="certbot-简介"></a>Certbot 简介<a class="hash-link" href="#certbot-简介" title="Direct link to heading">#</a></h3><p>Certbot 是 Let&#x27;s Encrypt 官方推荐的获取证书的客户端，可以帮我们获取免费的 Let&#x27;s Encrypt 证书。Certbot 是 EFF 加密整个互联网的一部分。通过 Web 进行安全通信依赖于 HTTPS，这需要使用数字证书，以便浏览器验证 Web 服务器的身份。Certbot 是支持所有 Unix 内核的操作系统的。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="申请与配置"></a>申请与配置<a class="hash-link" href="#申请与配置" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="certbot-安装"></a>Certbot 安装<a class="hash-link" href="#certbot-安装" title="Direct link to heading">#</a></h3><ol><li>使用 <code>Git</code> 下载 <code>certbot</code></li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ git clone https://github.com/certbot/certbot</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd certbot</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol><li><code>certbot-auto</code> 或者 <code>letsencrypt-auto</code>查看命令参数</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./certbot-auto --help</span></span><span class="token-line" style="color:#393A34"><span class="token plain">或者</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./letsencrypt-auto --help</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly s"><pre tabindex="0" class="prism-code language-s codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">obtain, install, and renew certificates:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(default) run   Obtain &amp; install a certificate in your current webserver</span></span><span class="token-line" style="color:#393A34"><span class="token plain">certonly        Obtain or renew a certificate, but do not install it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">renew           Renew all previously obtained certificates that are near</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">expiry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  enhance         Add security enhancements to your existing configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d DOMAINS       Comma-separated list of domains to obtain a certificate for</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --apache          Use the Apache plugin for authentication &amp; installation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --standalone      Run a standalone webserver for authentication</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --nginx           Use the Nginx plugin for authentication &amp; installation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --webroot         Place files in a server&#x27;s webroot folder for authentication</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --manual          Obtain certificates interactively, or using shell script</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>这里只对几个重要的命令参数进行说明</p><ul><li>run：获取并安装证书到当前的 Web 服务器</li><li>certonly：获取或续期证书，但是不安装</li><li>renew：在证书快过期时，续期之前获取的所有证书</li><li>-d DOMAINS：一个证书支持多个域名，用逗号分隔</li><li>--apache：使用 Apache 插件来认证和安装证书</li><li>--standalone：运行独立的 web server 来验证</li><li>--nginx：使用 Nginx 插件来认证和安装证书</li><li>--webroot：如果目标服务器已经有 web server 运行且不能关闭，可以通过往服务器的网站根目录放置文件的方式来验证</li><li>--manual：通过交互式方式，或 Shell 脚本手动获取证书</li></ul><blockquote><p>关于域名验证和证书的获取安装，上面提到了<code>5种</code>方式：--apache, --standalone, --nginx, --webroot 和 --manual，请根据实际情况选择其一。这里会讲常用 Nginx 安装方式。</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="获取证书"></a>获取证书<a class="hash-link" href="#获取证书" title="Direct link to heading">#</a></h3><ol><li>使用 <code>certbot-auto</code> 来获取证书但不安装</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./certbot-auto --email zeffonwu@gmail.com -d &quot;*.thxycn.xin&quot; -d &quot;thxycn.xin&quot; --manual --preferred-challenges dns-01 certonly --server https://acme-v02.api.letsencrypt.org/directory</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>注意将上面的邮箱和域名替换成自己的。需要两个-d：第一是通配符域名配置，第二个是主域名配置</p><blockquote><p><strong><code>注意</code></strong></p><ol><li>执行此命令必须使用 root 用户获得文件夹的权限</li><li>域名能访问并且有绑定的公网 IP</li><li>必须在此域名绑定的服务器上运行</li><li>会使用 80 断端口，如果 nginx 监听 80 端口，把 nginx 先关掉</li></ol></blockquote><ol start="2"><li>需要在域名上新添加一条解析记录(由于设置两个域名，这里解析记录值也要弄两次)
(<code>主机</code>：_acme-challenge <code>类型</code>：TXT <code>记录值</code>：L435P35DFHIBAOF34548QoqJHbD162748HUDF)</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Please deploy a DNS TXT record under the name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">_acme-challenge.thxycn.xin with the following value:</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">L435P35DFHIBAOF34548QoqJHbD162748HUDF</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Before continuing, verify the record is deployed.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><blockquote><p><strong><code>注意</code>:</strong> 申请通配符证书是要经过 DNS 认证的，按照提示，前往域名后台添加对应的 DNS TXT 记录。添加之后，不要心急着按回车，先执行 dig xxxx.xxx.com txt 确认解析记录是否生效，生效之后再回去按回车确认</p></blockquote><p>dig 命令安装：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ yum install bind-utils</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ dig _acme-challenge.thxycn.xin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">下文出现TXT的值则可以</span></span><span class="token-line" style="color:#393A34"><span class="token plain">;; ANSWER SECTION:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">_acme-challenge.thxycn.xin. 600 IN      TXT     &quot;Refivf35ferdfaypw7ZvfnmkbHDSD8433IGA&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="3"><li>获取证书出现如下的 <code>NOTES</code>,说明证书创建成功了</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">IMPORTANT NOTES:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">- Congratulations! Your certificate and chain have been saved at:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /etc/letsencrypt/live/thxycn.xin/fullchain.pem</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Your key file has been saved at:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /etc/letsencrypt/live/thxycn.xin/privkey.pem</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Your cert will expire on 2019-11-30. To obtain a new or tweaked</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  version of this certificate in the future, simply run</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  letsencrypt-auto again. To non-interactively renew *all* of your</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  certificates, run &quot;letsencrypt-auto renew&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="4"><li>查看证书(证书默认保存在<code>/etc/letsencrypt/live/thxycn.xin</code>)</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">README  cert.pem  chain.pem  fullchain.pem  privkey.pem</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>而 Nginx 配置证书我们需要用到的证书是 <code>fullchain.pem</code> 和 <code>privkey.pem</code>。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="nginx-证书配置"></a>Nginx 证书配置<a class="hash-link" href="#nginx-证书配置" title="Direct link to heading">#</a></h3><ol><li>配置 conf 文件（<code>注意</code>更换自己的证书）</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">server {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen 443;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_name thxycn.xin;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl on;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_certificate /etc/letsencrypt/live/thxycn.xin/fullchain.pem; # 替换自己的证书</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_certificate_key /etc/letsencrypt/live/thxycn.xin/privkey.pem; # 替换自己的证书</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_session_cache shared:SSL:1m;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_session_timeout 5m;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_prefer_server_ciphers on;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        root   /usr/share/nginx/html;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        index  index.html index.htm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_page   500 502 503 504  /50x.html;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    location = /50x.html {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        root   /usr/share/nginx/html;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">server {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen 80;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_name thxycn.xin;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    rewrite ^/(.*) https://$server_name$request_uri? permanent;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="2"><li>验证是否配置成功
使用 <code>https://thxycn.xin/index.html</code> 能访问到 Nginx 的欢迎页面，则配置成功。</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="自动更新-ssl-证书"></a>自动更新 SSL 证书<a class="hash-link" href="#自动更新-ssl-证书" title="Direct link to heading">#</a></h3><p>Let&#x27;s Encrypt 提供的证书只有 90 天的有效期，所以我们需要写一个脚本在过期前定时重新获取证书。并且证书获取是要频次限制的--每 7 天 5 次。(limit ~5 per 7 days)。</p><ol><li>使用 <code>certbot renew</code> 自动更新证书</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ certbot-auto renew --manual # 需要进入/usr/local/certbot目录</span></span><span class="token-line" style="color:#393A34"><span class="token plain">或者可以使用强制更新</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ certbot-auto --force-renew</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><blockquote><p>但是却报错了。原因: 重新更新证书需要启动 443 端口，而这个端口被 nginx 占用着
解决方法: 其实很简单，就是在执行<code>certbot renew --dry-run</code>命令前，把 Nginx 停止 <code>systemctl stop nginx</code>, 执行成功后就把 Nginx 启动 <code>systemctl start nginx</code>。所以需要用到 <code>--pre-hook</code>（这个参数表示执行更新操作之前要做的事情）,<code>--post-hook</code>(这个参数表示执行更新操作完成后要做的事情)</p></blockquote><ol><li>定时设置(每 1 个月，凌晨 10 分执行)
新建 certbot-auto-renew-crontab.sh 文件</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ mkdir crontab # 与usr同级下新建crontab目录</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ vi certbot-auto-renew-crontab.sh</span></span><span class="token-line" style="color:#393A34"><span class="token plain">10 0 * 1 * /usr/local/certbot/certbot-auto --force-renew --pre-hook &quot;systemctl stop nginx&quot; --post-hook &quot;systemctl start nginx&quot; # --force-renew 强制更新</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="2"><li>用 <code>crontab</code> 来启动这个定时任务</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ crontab certbot-auto-renew-crontab.sh</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/linux">linux</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/https">https</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/zeffon/zeffon.github.io/blob/master/blog/2019/2019-09-09-how-apply-https.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/linux-install-docker"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« Linux搭建Docker环境</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/avl-and-red–black-tree"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">AVL树、红黑树和哈希表 »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link">前言</a><ul><li><a href="#lets-encrypt-简介" class="table-of-contents__link">Let&#39;s Encrypt 简介</a></li><li><a href="#certbot-简介" class="table-of-contents__link">Certbot 简介</a></li></ul></li><li><a href="#申请与配置" class="table-of-contents__link">申请与配置</a><ul><li><a href="#certbot-安装" class="table-of-contents__link">Certbot 安装</a></li><li><a href="#获取证书" class="table-of-contents__link">获取证书</a></li><li><a href="#nginx-证书配置" class="table-of-contents__link">Nginx 证书配置</a></li><li><a href="#自动更新-ssl-证书" class="table-of-contents__link">自动更新 SSL 证书</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">文档</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="mailto:ZeffonWu@gmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>ZeffonWu@gmail.com<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://www.yuque.com/zeffon/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>语雀<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Zeffon, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.89f3db80.js"></script>
<script src="/assets/js/main.410e0645.js"></script>
</body>
</html>