---
slug: koa-web
title: ä½¿ç”¨ TypeScript æ„å»º Koa2 RESTful API æœ€ä½³çš„è„šæ‰‹æ¶
authors: zeffon
tags: [js, node]
date: 2022-04-13 12:11
---

[koa2](https://koa.bootcss.com/) æ˜¯åŸºäº NodeJS ä¸‹ä¸€ä»£ Web å¼€å‘æ¡†æ¶ã€‚ä½†æ˜¯ï¼ŒKoa2 å¹¶æ²¡æ³•åƒ Java çš„ SpringBoot æ¡†æ¶é‚£èˆ¬å¼€ç®±å³ç”¨ã€‚Koa2 å¦‚æœä¸é€šè¿‡äºŒæ¬¡å°è£…ï¼ŒçœŸçš„å¾ˆéš¾ç›´æ¥ä½œä¸º Web å¼€å‘æ¡†æ¶å¼€å‘å…·ä½“çš„ä¸šåŠ¡ã€‚
Koa æœ€ä¸»è¦çš„æ ¸å¿ƒå°±æ˜¯ åº”ç”¨ä¸Šä¸‹æ–‡ å’Œ ä¸­é—´ä»¶ã€‚å› æ­¤ï¼ŒKoa2 å¦‚æœæƒ³è¦åƒ SpringBoot å¯ä»¥ç»™å¼€å‘è€…å¼€ç®±å³ç”¨ï¼Œæ˜¾ç„¶æ˜¯ä¸å¯èƒ½ã€‚è€Œä¸”ï¼ŒKoa2 åœ¨ä»¥å‰ç‰ˆæœ¬æ˜¯ä¸æ”¯æŒ ESModule çš„ï¼Œå³æ— æ³•ä½¿ç”¨ import å¯¼å…¥ï¼Œåªèƒ½ä½¿ç”¨ requireã€‚ä¸è¿‡ç›®å‰ Koa ä¾èµ– **node v7.6.0+** æˆ– ES2015 åŠæ›´é«˜ç‰ˆæœ¬å’Œ async æ–¹æ³•æ”¯æŒï¼Œå¯ä»¥å®ç° ESModule æ–¹å¼çš„ä½¿ç”¨ã€‚
éšç€ Typescript çš„æ™®åŠï¼Œä½œä¸º NodeJS çš„å¼€å‘æ¡†æ¶å½“ç„¶ä½¿ç”¨ **TS **ç±»å‹æ‰èƒ½é™ä½ç»´æŠ¤æˆæœ¬ã€‚å¯¹æ­¤ï¼Œæœ¬äººåœ¨ Koa2 + Typescript çš„åŸºç¡€é›†æˆäº†ä¸€ä¸ª Web å¼€å‘æ¡†æ¶ -- [**koa-web**](https://github.com/zeffon/koa-web)**ã€‚**å¤§å®¶è¦æ˜¯è§‰å¾—**koa-web**ä¸é”™ï¼Œå¯ä»¥ç»™ä¸ª**star**ï¼Œ**è°¢è°¢ï¼**

<!--truncate-->

## å‰è¨€

[koa2](https://koa.bootcss.com/) æ˜¯åŸºäº NodeJS ä¸‹ä¸€ä»£ Web å¼€å‘æ¡†æ¶ã€‚ä½†æ˜¯ï¼ŒKoa2 å¹¶æ²¡æ³•åƒ Java çš„ SpringBoot æ¡†æ¶é‚£èˆ¬å¼€ç®±å³ç”¨ã€‚Koa2 å¦‚æœä¸é€šè¿‡äºŒæ¬¡å°è£…ï¼ŒçœŸçš„å¾ˆéš¾ç›´æ¥ä½œä¸º Web å¼€å‘æ¡†æ¶å¼€å‘å…·ä½“çš„ä¸šåŠ¡ã€‚
Koa æœ€ä¸»è¦çš„æ ¸å¿ƒå°±æ˜¯ åº”ç”¨ä¸Šä¸‹æ–‡ å’Œ ä¸­é—´ä»¶ã€‚å› æ­¤ï¼ŒKoa2 å¦‚æœæƒ³è¦åƒ SpringBoot å¯ä»¥ç»™å¼€å‘è€…å¼€ç®±å³ç”¨ï¼Œæ˜¾ç„¶æ˜¯ä¸å¯èƒ½ã€‚è€Œä¸”ï¼ŒKoa2 åœ¨ä»¥å‰ç‰ˆæœ¬æ˜¯ä¸æ”¯æŒ ESModule çš„ï¼Œå³æ— æ³•ä½¿ç”¨ import å¯¼å…¥ï¼Œåªèƒ½ä½¿ç”¨ requireã€‚ä¸è¿‡ç›®å‰ Koa ä¾èµ– **node v7.6.0+** æˆ– ES2015 åŠæ›´é«˜ç‰ˆæœ¬å’Œ async æ–¹æ³•æ”¯æŒã€‚
éšç€ Typescript çš„æ™®åŠï¼Œä½œä¸º NodeJS çš„å¼€å‘æ¡†æ¶å½“ç„¶ä½¿ç”¨ **TS **ç±»å‹æ‰èƒ½é™ä½ç»´æŠ¤æˆæœ¬ã€‚å¯¹æ­¤ï¼Œæœ¬äººåœ¨ Koa2 + Typescript çš„åŸºç¡€é›†æˆäº†ä¸€ä¸ª Web å¼€å‘æ¡†æ¶ -- [**koa-web**](https://github.com/zeffon/koa-web)**ã€‚**å¤§å®¶è¦æ˜¯è§‰å¾—**koa-web**ä¸é”™ï¼Œå¯ä»¥ç»™ä¸ª**star**ï¼Œ**è°¢è°¢ï¼**

**koa-web** Github åœ°å€ï¼š[https://github.com/zeffon/koa-web](https://github.com/zeffon/koa-web)

**koa-web** npm åœ°å€ï¼š[https://www.npmjs.com/package/create-koa-web](https://www.npmjs.com/package/create-koa-web)

## æ­£æ–‡

**Koa-web**

- ğŸ’¡ **TypeScript**: æ”¯æŒ TypeScript
- ğŸ¨ **prettier**ï¼šprettier è§„èŒƒä»£ç æ ¼å¼
- ğŸš€ **å…¨å±€å¼‚å¸¸**ï¼šå…¨å±€å¼‚å¸¸ç»Ÿä¸€å¤„ç†
- âœˆï¸ **æ•°æ®æ ¡éªŒ**ï¼šå®ç”¨ä¸”é«˜æ•ˆçš„æ•°æ®æ ¡éªŒæ–¹å¼
- ğŸ€ **Database**ï¼šæ”¯æŒ Sequelize è¿æ¥
- ğŸ”¥ **Redis**ï¼šæ”¯æŒ Redis æ•°æ®åº“è¿æ¥
- âš¡ **Cache**ï¼šæ”¯æŒ æœ¬åœ°ç¼“å­˜
- âœï¸ **Auth**ï¼šé€šç”¨ JWT æˆæƒ
- ğŸ“– **æ—¥å¿—**ï¼šè®°å½• SQL æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—
- âœ… **å•å…ƒæµ‹è¯•**ï¼šæ”¯æŒå•å…ƒæµ‹è¯•
- ğŸ“ **API æ–‡æ¡£**ï¼šAPI æ–‡æ¡£æµ‹è¯•

### è¿è¡Œ

å¦‚æœä½ æƒ³è¦ä½¿ç”¨ **koa-web** æ¥ä½œä¸º web å¼€å‘æ¡†æ¶ï¼Œæ˜¯ä¸éœ€è¦ä¸‹è½½ github ä»£ç ï¼Œç›´æ¥ä½¿ç”¨ npm å‘½ä»¤å¿«é€Ÿæ­å»ºè„šæ‰‹æ¶

```javascript
$ npm create koa-web@latest
# æˆ–è€…æŒ‡å®šé¡¹ç›®åç§°
$ npm create koa-web@latest koa-web-project
```

å®‰è£…å®Œæ¯•ï¼Œå³å¯è¿è¡Œ

```javascript
# 1. æ‰“å¼€å®‰è£…çš„é¡¹ç›®
$ cd koa-web-project

# 2. å®‰è£…ä¾èµ–
$ npm install

# 3. è¿è¡Œé¡¹ç›®
$ npm run start

# 4. æ‰“å¼€åœ¨çº¿æ–‡æ¡£
# please open in: http://127.0.0.1:3000/koa-web/v1/doc.html
```

### ä½¿ç”¨

ä¸€ä¸ª web å¼€å‘æ¡†æ¶æœ€æ ¸å¿ƒã€æœ€åŸºç¡€çš„æ— éå°±æ˜¯ä»å¼‚å¸¸å¤„ç†å’Œæ•°æ®æ ¡éªŒè¿™ä¸¤ä¸ªæ¨¡å—å¼€å§‹ã€‚

#### å…¨å±€å¼‚å¸¸

å€ŸåŠ© Koa2 ä¸­é—´ä»¶çš„ç‰¹æ€§å®ç°äº†å…¨å±€å¼‚å¸¸æ•è·åŠå¤„ç†ã€‚
Koa-web ä¸­ï¼Œå¼‚å¸¸åˆ†ä¸ºä¸¤ç§ï¼š

1. å·²çŸ¥å¼‚å¸¸
1. æœªçŸ¥å¼‚å¸¸

**å·²çŸ¥å¼‚å¸¸ï¼ˆHTTP å¼‚å¸¸ï¼‰** åˆåˆ†ä¸ºï¼š

1. å‚æ•°å¼‚å¸¸ ParameterException
1. æœªæˆæƒå¼‚å¸¸ UnAuthenticatedException
1. ç¦æ­¢è®¿é—®å¼‚å¸¸ ForbiddenException
1. 404 å¼‚å¸¸ NotFoundException
1. æœåŠ¡ä¸å¯ç”¨å¼‚å¸¸ ServerErrorException
1. æ•°æ®æ“ä½œ GETã€POSTã€PUTã€DELETEï¼ˆKoa-web å¯¹æ•°æ®æ“ä½œæˆåŠŸä¹Ÿç®—æ˜¯ä¸€ç§å¼‚å¸¸ï¼‰

é€šè¿‡åœ¨ `exception-code`å®šä¹‰ç›¸å¯¹åº”**é”™è¯¯ç **å’Œ**é”™è¯¯æç¤º**ï¼ŒæŠ›å‡ºå»å¼‚å¸¸å°±å¯ä»¥ç»Ÿä¸€æ ¼å¼äº†ã€‚
åœ¨ç³»ç»Ÿåˆå§‹åŒ–é˜¶æ®µï¼Œ`UnifyResponse`ç»Ÿä¸€è¿”å›æ ¼å¼ èµ‹å€¼ç»™ `global.UnifyResponse`,ä¹‹ååœ¨ç¼–å†™ä¸šåŠ¡ä»£ç ä¾¿å¯ä»¥ä½¿ç”¨ `global.UnifyResponse`æ ¹æ®ç¡®å®šçš„å¼‚å¸¸åˆ†ç±»è¿”å›å¯¹åº”çš„å¼‚å¸¸ä¿¡æ¯ã€‚

**æœªçŸ¥å¼‚å¸¸** ä¸€èˆ¬æ˜¯æœªå‘ç°çš„å¼‚å¸¸æç¤ºï¼Œç›®å‰å¯ä»¥é€šè¿‡è®°å½•æ—¥å¿—çš„æ–¹å¼è®°å½•è¯¥å¼‚å¸¸ä¿¡æ¯ã€‚

#### æ•°æ®æ ¡éªŒ

æ•°æ®æ ¡éªŒæœ‰ä¸¤ç§æ ¡éªŒå±‚æ¬¡ï¼Œä¸€ç§æ˜¯åŸºäº **koa-swagger-decorator** è¿›è¡Œç®€å•å‚æ•°ä¼ é€’çš„æ ¡éªŒï¼Œå¦ä¸€ç§æ˜¯åŸºäº **validator** å°è£…çš„å¤æ‚å‚æ•°æ ¡éªŒ **LinValidator**ï¼ˆæ¥è‡ª 7 ä¸ƒæœˆè€å¸ˆï¼‰ã€‚
[**koa-swagger-decorator**](https://github.com/Cody2333/koa-swagger-decorator) ä¸­çš„å‚æ•°æ ¡éªŒä¹Ÿæ˜¯åŸºäº **validator** ä¸Šã€‚è€Œ **Koa-web** ä¸ºä»€ä¹ˆæœ‰äº† è‡ªå·±å°è£…çš„å‚æ•°æ ¡éªŒå™¨ï¼Œè¿˜è¦ä½¿ç”¨ **koa-swagger-decorator** å‘¢ï¼Ÿä½¿ç”¨ **koa-swagger-decorator** æ˜¯æƒ³è®© **Koa-web** å¯ä»¥ **åœ¨çº¿ API æ–‡æ¡£** è°ƒè¯•ï¼Œè€Œ **koa-swagger-decorator** åœ¨å‚æ•°ä¼ é€’ä¸Šæœ‰è‡ªå·±ä¸€å¥—æ ¡éªŒè§„åˆ™ï¼Œæƒè¡¡ä¸€äºŒåï¼Œå°†ç®€å•è§„åˆ™çš„æ ¡éªŒæ”¾åœ¨ **koa-swagger-decorator** ï¼Œè€Œ **LinValidator** ç”¨æ¥æ ¡éªŒå¤æ‚å‚æ•°ã€‚

1. **koa-swagger-decorator** çš„è¯¦ç»†è§„åˆ™ä½¿ç”¨å¯ä»¥æŸ¥çœ‹å…¶å®˜æ–¹ [Github åœ°å€](https://github.com/Cody2333/koa-swagger-decorator)ã€‚
1. **LinValidator** çš„ä½¿ç”¨

**Koa-web** ç›¸å…³æ¨¡å—çš„æ ¡éªŒå™¨æ˜¯ç»Ÿä¸€æ”¾ç½®åœ¨ `src/app/api/valid` ç›®å½•ä¸‹ï¼Œæ¯”å¦‚ï¼š

```typescript
export class RegisterValidator extends LinValidator {
  private email;
  private nickname;
  private password1;
  private password2;
  private remark;

  constructor() {
    super();
    this.email = [
      new Rule("isLength", "Min 12 characters, max 32 characters", {
        min: 6,
        max: 32,
      }),
      new Rule("isEmail", "Please enter email format"),
    ];
    this.nickname = [
      new Rule("isLength", "Nickname does not match the length", {
        min: 4,
        max: 32,
      }),
    ];
    this.password1 = [
      new Rule("isLength", "Password has min 6 characters, max 32 characters", {
        min: 6,
        max: 32,
      }),
      new Rule(
        "matches",
        "Password does not meet specifications",
        "^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]"
      ),
    ];
    this.password2 = this.password1;
    this.remark = [
      new Rule("isOptional"), // å¯é€‰ï¼Œä¸æ ¡éªŒ
    ];
  }

  validatePassword(vals: any) {
    const password1 = vals.body.password1;
    const password2 = vals.body.password2;
    if (password1 !== password2) {
      throw new Error("Both passwords must be the same");
    }
  }
}
```

#### Auth è®¤è¯

core ç›®å½•ä¸‹ auth æ¨¡å—æ˜¯è®¤è¯æœºåˆ¶ã€‚**Koa-web** çš„æˆæƒæœºåˆ¶æ˜¯åŸºäº **jsonwebtoken** æ¥ **é¢å‘** å’Œ **æ ¡éªŒ** Token ä»¤ç‰Œçš„ã€‚Koa-web å…¨å±€æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œé™¤äº†åœ¨ **unlessPaths** ä¸­è·¯ç”±ï¼Œå…¶å®ƒæ‰€æœ‰çš„è¯·æ±‚éƒ½éœ€è¦åœ¨è¯·æ±‚å¤´ä¸Šæºå¸¦ **authorization** å‚æ•°åæ‰èƒ½æ­£å¸¸è®¿é—®ï¼Œä¸ç„¶åªèƒ½è¿”å› 401 è¯·æ±‚ã€‚
**unlessPaths** ä¸­è·¯ç”±æ•°ç»„å°±æ˜¯è¿‡æ»¤ url è·¯ç”±ã€‚**unlessPaths** æ”¯æŒå­—ç¬¦ä¸²ç²¾å‡†çš„è·¯ç”±å’Œæ­£åˆ™åŒ¹é…è§„åˆ™çš„è·¯ç”±æ–¹å¼ï¼ˆæ¨èä½¿ç”¨æ­£åˆ™æ–¹å¼ï¼‰ã€‚

```javascript
let unlessPaths = [
  /^\/koa-web\/v1\/json\.html[\/#\?]?$/i,
  /^\/koa-web\/v1\/doc\.html[\/#\?]?$/i,
  /^\/koa-web\/v1\/user\/login[\/#\?]?$/i,
  /^\/koa-web\/v1\/user\/register[\/#\?]?$/i
]
# æˆ–è€…
let unlessPaths = [
  '/koa-web/v1/json.html',
  '/koa-web/v1/doc.html',
  '/koa-web/v1/user/login',
  '/koa-web/v1/user/register'
]
```

#### æ•°æ®åº“è¿æ¥

æ•°æ®åº“æ˜¯ [**sequelize**](https://sequelize.org/) è¿›è¡Œè¿æ¥çš„ï¼Œé‡‡ç”¨ **MySQL** å¼•æ“ã€‚è€Œå¯¹æ•°æ®åº“æ“ä½œé‡‡ç”¨ **sequelize** çš„[æ¨¡å‹](https://github.com/demopark/sequelize-docs-Zh-CN/blob/v6/core-concepts/model-basics.md)ã€‚å¯ä»¥å‚è€ƒ **Koa-web** ä¸­çš„ user æ¨¡å—è¿›è¡Œæ¨¡å‹è®¾è®¡ï¼Œé…ç½®ä¸Šæ­£ç¡®çš„æ•°æ®åº“åœ°å€ä¾¿å¯ä»¥ç”Ÿæˆå¯¹åº”çš„è¡¨ç»“æ„ã€‚é…ç½®æ–‡ä»¶åœ¨ **config** ç›®å½•ä¸‹ï¼Œåˆ†æœ‰ä¸‰ç§è¿è¡Œç¯å¢ƒæ–‡ä»¶ï¼Œé€‰æ‹©å½“å‰è¿è¡Œç¯å¢ƒçš„æ–‡ä»¶è¿›è¡Œé…ç½® **DATABASE** ç›¸å…³å‚æ•°é…ç½®ã€‚

åœ¨ `src/app/api/model` ä¸‹ç¼–å†™å¯¹åº”çš„æ¨¡å‹ï¼Œå¹¶ä¸”éœ€è¦åœ¨ `index.ts` è¿›è¡Œå¯¼å‡ºï¼Œä¼šåœ¨ `src/core/database/init.ts` æ£€æµ‹åˆ°å®šä¹‰çš„æ¨¡å‹ï¼Œè¿›è¡Œæ•°æ®åº“è¡¨åˆ›å»ºã€‚

#### Redis æ•°æ®åº“

åœ¨ **config** é…ç½®ä¸‹ï¼ŒREDIS.ENABLED æ˜¯å¦å¼€å¯ Redis æœåŠ¡ï¼Œå¡«å†™æ­£ç¡®çš„ redis çš„ hostã€portã€password è¿æ¥ Redis å®¢æˆ·ç«¯ã€‚æä¾›ä¸‰ä¸ªæ–¹æ³•æ“ä½œæ•°æ®çš„å­˜å‚¨ã€è·å–ã€åˆ é™¤ï¼Œæ›´å¤šæ–¹æ³•å¯ä»¥è¿›è¡Œæ‰©å±•ã€‚

#### æœ¬åœ°ç¼“å­˜

æœ¬åœ°ç¼“å­˜æ˜¯å­˜å‚¨åœ¨ NodeJS è¿›ç¨‹ä¸­ï¼Œä¼šéšç€è¿›ç¨‹çš„é‡å¯è€Œè¢«æ¸…æ¥šç¼“å­˜æ•°æ®ã€‚å¯ä»¥å­˜å‚¨ä¸€äº›ä¸é‡è¦çš„æ•°æ®ã€‚

####

#### API æ–‡æ¡£

**API æ–‡æ¡£** æ˜¯é‡‡ç”¨ [**koa-swagger-decorator**](https://github.com/Cody2333/koa-swagger-decorator) å®ç°çš„ã€‚å¯ä»¥é€šè¿‡**è£…é¥°å™¨**çš„æ–¹å¼ï¼Œæ›´åŠ ç®€æ´å°† api æ¥å£ç¼–ç å‡ºæ¥ã€‚å¹¶ä¸”å€ŸåŠ© [**koa-swagger-decorator**](https://github.com/Cody2333/koa-swagger-decorator) å®ç°ç®€å•çš„å‚æ•°æ ¡éªŒã€‚åœ¨ API æ–‡æ¡£ä¸Šå¯ä»¥æ›´åŠ æ–¹ä¾¿åœ°ã€ç›´è§‚åœ°è¿›è¡Œè°ƒè¯•æ¥å£ã€‚
